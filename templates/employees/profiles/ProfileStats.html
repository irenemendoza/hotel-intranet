<!-- templates/employees/profile/ProfileStats.html -->
{% extends "layout.html" %}
{% load static %}

{% block title %}Estadísticas Detalladas{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard:home' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'profiles:my-profile' %}">Mi Perfil</a></li>
            <li class="breadcrumb-item active">Estadísticas</li>
        </ol>
    </nav>

    <!-- Header con filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h3 class="mb-0">
                        <i class="bi bi-graph-up"></i> Estadísticas Detalladas
                    </h3>
                    <p class="text-muted mb-0">{{ period_name }}</p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group" role="group">
                        <a href="?period=week" class="btn btn-outline-primary {% if period == 'week' %}active{% endif %}">
                            Semana
                        </a>
                        <a href="?period=month" class="btn btn-outline-primary {% if period == 'month' %}active{% endif %}">
                            Mes
                        </a>
                        <a href="?period=year" class="btn btn-outline-primary {% if period == 'year' %}active{% endif %}">
                            Año
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas de Asistencia -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> Asistencia
                    </h5>
                </div>
                <div class="card-body">
                    <!-- KPIs Principales -->
                    <div class="row text-center mb-4">
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h2 class="text-primary">{{ attendance_stats.total_days }}</h2>
                                <p class="text-muted mb-0">Días trabajados</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h2 class="text-success">{{ attendance_stats.on_time }}</h2>
                                <p class="text-muted mb-0">A tiempo</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h2 class="text-warning">{{ attendance_stats.late }}</h2>
                                <p class="text-muted mb-0">Tarde</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h2 class="text-info">{{ attendance_stats.punctuality_rate }}%</h2>
                                <p class="text-muted mb-0">Puntualidad</p>
                            </div>
                        </div>
                    </div>

                    <!-- Horas -->
                    <div class="row text-center mb-4">
                        <div class="col-md-6">
                            <div class="stat-box bg-light">
                                <h3 class="text-success">
                                    {{ attendance_stats.total_hours.hours }}h {{ attendance_stats.total_hours.minutes }}m
                                </h3>
                                <p class="text-muted mb-0">Total de horas trabajadas</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stat-box bg-light">
                                <h3 class="text-info">
                                    {{ attendance_stats.average_hours.hours }}h {{ attendance_stats.average_hours.minutes }}m
                                </h3>
                                <p class="text-muted mb-0">Promedio por día</p>
                            </div>
                        </div>
                    </div>

                    <!-- Gráfico de horas diarias -->
                    <h6 class="mb-3"><i class="bi bi-bar-chart"></i> Horas Trabajadas por Día</h6>
                    <canvas id="dailyHoursChart" height="80"></canvas>
                </div>
            </div>
        </div>

        <!-- Gráfico de distribución -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart"></i> Distribución
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="attendanceDistributionChart"></canvas>
                    
                    <div class="mt-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-circle-fill text-success"></i> A tiempo</span>
                            <strong>{{ attendance_stats.on_time }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-circle-fill text-warning"></i> Tarde</span>
                            <strong>{{ attendance_stats.late }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas de Permisos -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-event"></i> Permisos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h2 class="text-primary">{{ leave_stats.total }}</h2>
                                <p class="text-muted mb-0">Total de solicitudes</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h2 class="text-success">{{ leave_stats.approved }}</h2>
                                <p class="text-muted mb-0">Aprobados</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h2 class="text-warning">{{ leave_stats.pending }}</h2>
                                <p class="text-muted mb-0">Pendientes</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h2 class="text-danger">{{ leave_stats.rejected }}</h2>
                                <p class="text-muted mb-0">Rechazados</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas específicas por rol (Tareas) -->
    {% if task_stats %}
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">
                        {% if request.user.employee.role in 'camarero_piso,jefe_limpieza' %}
                            <i class="bi bi-droplet"></i> Tareas de Limpieza
                        {% else %}
                            <i class="bi bi-tools"></i> Tareas de Mantenimiento
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h2 class="text-primary">{{ task_stats.total }}</h2>
                                <p class="text-muted mb-0">Total de tareas</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h2 class="text-success">{{ task_stats.completed }}</h2>
                                <p class="text-muted mb-0">Completadas</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h2 class="text-warning">{{ task_stats.pending }}</h2>
                                <p class="text-muted mb-0">Pendientes</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                {% if task_stats.urgent %}
                                    <h2 class="text-danger">{{ task_stats.urgent }}</h2>
                                    <p class="text-muted mb-0">Urgentes</p>
                                {% else %}
                                    <h2 class="text-info">{{ task_stats.in_progress|default:0 }}</h2>
                                    <p class="text-muted mb-0">En progreso</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if task_stats.total > 0 %}
                    <hr>
                    <div class="progress" style="height: 30px;">
                        {% with completed_pct=task_stats.completed|floatformat:0 total=task_stats.total %}
                        {% widthratio task_stats.completed task_stats.total 100 as completion_rate %}
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ completion_rate }}%;" 
                             aria-valuenow="{{ completion_rate }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ completion_rate }}% Completadas
                        </div>
                        {% endwith %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Botones de acción -->
    <div class="row">
        <div class="col-12 text-center">
            <a href="{% url 'profiles:my-profile' %}" class="btn btn-primary">
                <i class="bi bi-arrow-left"></i> Volver a Mi Perfil
            </a>
            <button onclick="window.print()" class="btn btn-secondary">
                <i class="bi bi-printer"></i> Imprimir
            </button>
        </div>
    </div>
</div>

<style>
.stat-box {
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 10px;
}

.stat-box h2, .stat-box h3 {
    margin-bottom: 5px;
    font-weight: bold;
}

@media print {
    .navbar, .btn, .breadcrumb {
        display: none !important;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de horas diarias
    const dailyHoursCtx = document.getElementById('dailyHoursChart');
    if (dailyHoursCtx) {
        new Chart(dailyHoursCtx, {
            type: 'bar',
            data: {
                labels: {{ daily_hours.keys|safe }},
                datasets: [{
                    label: 'Horas Trabajadas',
                    data: {{ daily_hours.values|safe }},
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Horas'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Gráfico de distribución
    const distributionCtx = document.getElementById('attendanceDistributionChart');
    if (distributionCtx) {
        new Chart(distributionCtx, {
            type: 'doughnut',
            data: {
                labels: ['A tiempo', 'Tarde'],
                datasets: [{
                    data: [
                        {{ attendance_by_status.present }},
                        {{ attendance_by_status.late }}
                    ],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 206, 86, 0.8)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}